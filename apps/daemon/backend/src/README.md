# Backend `src/` (Python packages)

This directory is the import root for the backend Python codebase (installed as the `voice2machine` distribution).

It contains:

- `v2m/`: the main backend package (daemon, hexagonal core, IPC protocol).
- `v2m_engine/`: a Rust (PyO3) performance engine (currently not wired into the Python runtime by default).
- `voice2machine.egg-info/`: build metadata generated by packaging tooling.

If you are looking for _how to run the backend_, start at `apps/backend/README.md`.

## Architecture (macro)

Voice2Machine backend follows a **hexagonal architecture** (Ports & Adapters):

- **Domain**: pure business concepts + protocols (no infrastructure imports).
- **Application**: use cases (commands/handlers) orchestrating domain behavior.
- **Infrastructure**: concrete adapters (Whisper, audio capture, external LLM clients).
- **Core**: plumbing (DI container, command bus, logging, IPC framing).

This is also a **local-first** system:

- Audio stays on-device.
- IPC is via Unix socket (no network service by default).
- Secrets (e.g. API keys) must come from env vars or a local `.env`, never committed.

## Module map

### `v2m/` (Python)

See `v2m/README.md` for the detailed, package-level map.

Common entry points:

- `python -m v2m.main --daemon` (start the daemon)
- `python -m v2m.main PING` / `START_RECORDING` / `STOP_RECORDING` (send IPC command)

### `v2m_engine/` (Rust)

See `v2m_engine/README.md` for details.

At a glance:

- Rust 2024 + `pyo3` extension-module.
- Audio capture via `cpal`, ring buffer via `ringbuf`.
- High-quality resampling via `rubato`.
- VAD via `webrtc-vad`.

### `voice2machine.egg-info/` (generated)

See `voice2machine.egg-info/README.md`.

## Conventions

- **Imports**: `v2m.domain` must not import from `v2m.infrastructure`.
- **Async first**: keep the event loop responsive; offload CPU-heavy work to threads/executors.
- **Paths**: runtime files must be XDG-compliant (use helpers under `v2m.utils.paths`).
- **Config**: `apps/backend/config.toml` is the committed default; secrets come from env vars.

## Where to make changes

- Add a new user-visible behavior → `v2m/application/` (use case) + `v2m/domain/` (protocols/errors) + an adapter in `v2m/infrastructure/`.
- Add a new IPC command → `v2m/core/ipc_protocol.py` (schema/enum) + route in `v2m/daemon.py` + handler in `v2m/application/`.
- Change config surface → `v2m/config.py` + `apps/backend/config.toml`.

## Documentation

Detailed documentation lives under `apps/backend/docs/docs/es/` (Spanish).
Keep docs in sync when behavior changes.
